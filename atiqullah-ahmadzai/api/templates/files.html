{% load static %}

<!DOCTYPE html>
<html lang="en">

{% include 'partials/header.html' %}

<body id="page-top">
    
    <!-- Page Wrapper -->
    <div id="wrapper">
        
        <!-- Sidebar -->
        {% include 'partials/sidebar.html' %}
        <!-- End of Sidebar -->
        
        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">
            
            <!-- Main Content -->
            <div id="content">
                
                <!-- Topbar -->
                {% include 'partials/nav.html' %}
                <!-- End of Topbar -->
                
                <!-- Begin Page Content -->
                <div class="container-fluid">
                    <h2>{{project.name}}

                        {% if project.has_repo == "Yes" %}
                        <a href="#" id="pull_repo" style="float:right;padding-left:15px"><i class="fa fa-code-pull-request"></i></a>
                        {% endif %}
                        <a href="#" id="uploadFileModalBtn" style="float:right;padding-left:15px"><i class="fa fa-file" data-toggle="modal" data-target="#uploadFileModal"></i></a>
                    </h2>
                    
                    <hr>
                    <!-- Content Row -->
                    <div class="row">
                        
                        <div class="col-md-12">
                            
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Select Model</label>
                                        <select id="model" class="form-control">
                                            <option value="LSTM">Bi-LSTM</option>
                                            <option value="GPT">ChatGPT 3.5 Turbo</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Select File(s) or
                                            <a href="#" id="uploadFileModalBtn" data-toggle="modal" data-target="#uploadFileModal">Upload File</a>
                                        </label>
                                        <select name="files[]" id="files" class="form-control code-files" multiple="multiple">
                                            {% for row in files %}
                                            <option>{{row.name}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4 modes">
                                   
                                    <label>Choose Mode</label>
                                    <select id="lstm-mode" class="form-control">
                                        <option value="xss">XSS</option>
                                        <option value="path_disclosure">Path Disclosure</option>
                                        <option value="remote_code_execution">Remote Code Execution</option>
                                        <option value="command_injection">Command Injection</option>
                                        <option value="open_redirect">Open Redirect</option>
                                        <option value="sql">SQL Injection</option>
                                        <option value="xsrf">XSRF</option>
                                    </select>
                                </div>
                                
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group" style="text-align:left;margin-top:31px">
                                        <button class="generate from-control btn btn-primary" style="width:40%">Generate</button>
                                        <button class="copy from-control btn btn-success" style="width:30%">Copy</button>
                                    </div>
                                    
                                </div>

                            </div>
                            
                            
                            
                            
                            <div class="row">

                                <div class="col-md-6">
                                    <label>Model Result</label>
                                    <span class="badge bg-badge"> <i class="fa fa-moon"> </i></span>
                                    
                                </div>
                                    
                                <div class="col-md-6 modes" style="text-align: right;">
                                    <label>Result Threshold Colors: </label>
                                    <span class="badge badge-green">0.1</span>
                                    <span class="badge badge-limegreen">0.2</span>
                                    <span class="badge badge-greenyellow">0.3</span>
                                    <span class="badge badge-yellow">0.4</span>
                                    <span class="badge badge-gold">0.5</span>
                                    <span class="badge badge-orange">0.6</span>
                                    <span class="badge badge-darkorange">0.7</span>
                                    <span class="badge badge-red">0.8</span>
                                    <span class="badge badge-darkred">0.9</span>
   
                                </div>                             
                              
                                <div class="col-md-12">
                                    <pre id="result" class="prettyprint" style="text-wrap:balance">...</pre>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    
                    
                </div>
                <!-- /.container-fluid -->
                
            </div>
            <!-- End of Main Content -->
            
            <!-- Footer -->
            {% include 'partials/footer.html' %}
            <!-- End of Footer -->
            
        </div>
        <!-- End of Content Wrapper -->
        
    </div>
    <!-- End of Page Wrapper -->
    
    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
        <i class="fas fa-angle-up"></i>
    </a>
    
    <!-- Logout Modal-->
    {% include 'partials/modals.html' %}
    {% include 'partials/scripts.html' %}
    
    <script>
        $(document).ready(function(){
            function checkCondition(id) {
                var url = "/response/"+id;
                $.ajax({
                    url: url, 
                    type: 'GET',
                    success: function(response) {
                        if (response.response.includes("img")) {
                            $(".generate").attr("disabled",false);
                            $(".generate").text("Generate");
                            $("#result").html(response.response);
                        } else {
                            console.log("Condition not met, retrying...");
                            setTimeout(function() {
                                checkCondition(id);
                            }, 3000);
                        }
                    },
                    error: function(error) {
                        console.error("Error in AJAX request", error);
                        setTimeout(function() {
                            checkCondition(id);
                        }, 3000); 
                    }
                });
            }

            $("#model").on("change",function(){
                if(this.value == "LSTM")
                {
                    $(".modes").show()
                }
                else
                {
                    $(".modes").hide()
                }
            });
            $(".copy").click(function(){
                var result = $("#result").text();
                copyToClipboard(result);
                $.notify("Success! Result coppied to the clipboard!", "success");
            });
            
            $(".generate").click(function(){
                $("#result").html("")
                $(".generate").attr("disabled",true);
                $(".generate").text("Generating...");
                var model = $("#model").val();
                var files = $("#files").val();
                if (files.length > 0)
                {
                    $.ajax({
                    url: '{% url 'ask_ai' project.id %}',
                    type: 'POST',
                    headers: {
                        'X-CSRFToken': "{{csrf_token}}" // Include the CSRF token in the headers
                    },
                    data: {
                        'model': model,
                        'files': files,
                        'mode': $('#lstm-mode').val()
                    },
                    success: function(response) {
    
                        $("#result").html(response.result);

                        if(model == "GPT")
                        {
                    
                            $("#result").html(response.result);
                            if(!response.result.includes("too lengthy"))
                            {
                                const eventSource = new EventSource("/project/stream_gpt/"+response.id);  
                                eventSource.onmessage = function(event) {
                                    if(event.data.includes("#END"))
                                    {
                                        eventSource.close();
                                        $(".generate").attr("disabled",false);
                                        $(".generate").text("Generate");
                                    }
                                    else
                                    {
                                        let formattedResponse = event.data.replace(/\\n/g, '<br>').replace(/\\"/g, '')
                                        $("#result").html(JSON.parse(event.data));
                                    }
                                    
                                };
                            }
                            else
                            {
                                $(".generate").attr("disabled",false);
                                $(".generate").text("Generate");
                            }

                        }
                        else
                        {
                            checkCondition(response.id);
                        }
                    },
                    error: function(error) {
                        // Handle any errors
                        $.notify("There are some issues with the server, try again later!", "error");
                        $(".generate").attr("disabled",false);
                        $(".generate").text("Generate");
                    }
                });
                }
                else
                {
                    $(".generate").attr("disabled",false);
                    $(".generate").text("Generate");
                    $.notify("Please select a file!", "error");
                }
                
            });
            
            $("#reload_vector").click(function(){
                event.preventDefault();
                $.ajax({
                    url: '{% url 'convert_to_vector' project.id %}',
                    type: 'GET',
                    headers: {
                        'X-CSRFToken': "{{csrf_token}}" // Include the CSRF token in the headers
                    },
                    success: function(response) {
                        $.notify("Success! vector conversion has started", "success");
                    },
                    error: function(error) {
                        $.notify("There are some issues with the server, try again later!", "error");
                    }
                });
            });
            $("#pull_repo").click(function(){
                event.preventDefault();
                $.notify("Success! pulling repo has started", "success");
                $.ajax({
                    url: '{% url 'pull_repo' project.id %}',
                    type: 'GET',
                    headers: {
                        'X-CSRFToken': "{{csrf_token}}" // Include the CSRF token in the headers
                    },
                    success: function(response) {
                        $.notify("Success! pull repo has finished, wait for the files to process", "success");
                    },
                    error: function(error) {
                        $.notify("There are some issues with the server, try again later!", "error");
                    }
                });
            });

            $(".bg-badge").click(function(){
                $(this).toggleClass("badge-primary");
                $("#result").toggleClass("dark-mode");
            });
        });
        Dropzone.options.myGreatDropzone = { 
            paramName: "file",
            maxFilesize: 2,
            acceptedFiles: ".py", 
            init: function() {
                this.on("success", function(file, response) {
                    window.location.reload();
                });
            }
        };
        
        function copyToClipboard(text) 
        {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }
    </script>
    
</body>

</html>